name: Deploy SPA CF Workers[Workerä¸€ä½“åŒ–éƒ¨ç½²]

on:
  push:
    branches: [main, master]
    paths:
      - "apps/ui/**"
      - "apps/worker/**"
  workflow_dispatch:
    inputs:
      from_panel:
        description: "æ˜¯å¦ç”±éƒ¨ç½²æ§åˆ¶é¢æ¿è§¦å‘ / triggered from deployment control panel"
        required: false
        default: "auto"
      deploy_action:
        description: "éƒ¨ç½²åŠ¨ä½œï¼šupdate/initï¼ˆé»˜è®¤ updateï¼‰"
        required: false
        default: "update"
      deploy_target:
        description: "éƒ¨ç½²ç›®æ ‡ï¼šfrontend/backend/both/autoï¼ˆé»˜è®¤ autoï¼‰"
        required: false
        default: "auto"
      apply_migrations:
        description: "æ•°æ®åº“è¿ç§»ï¼štrue/false/autoï¼ˆé»˜è®¤ autoï¼Œä»…è¿ç§»æ–‡ä»¶å˜æ›´æ—¶æ‰§è¡Œï¼‰"
        required: false
        default: "auto"
  repository_dispatch:
    types: [deploy-spa-button]

jobs:
  check-config:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      deploy_action: ${{ steps.plan.outputs.deploy_action }}
      deploy_target: ${{ steps.plan.outputs.deploy_target }}
      apply_migrations: ${{ steps.plan.outputs.apply_migrations }}
      deploy_ui: ${{ steps.plan.outputs.deploy_ui }}
      deploy_worker: ${{ steps.plan.outputs.deploy_worker }}
      should_migrate: ${{ steps.plan.outputs.should_migrate }}
      ui_changed: ${{ steps.changes.outputs.ui_changed }}
      worker_changed: ${{ steps.changes.outputs.worker_changed }}
      migrations_changed: ${{ steps.changes.outputs.migrations_changed }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” æ£€æŸ¥éƒ¨ç½²é…ç½®
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹åŠ¨è§¦å‘ï¼ˆrepository_dispatchï¼‰ï¼Œå¿½ç•¥å¼€å…³ï¼Œå…è®¸éƒ¨ç½²"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.from_panel }}" != "true" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰ï¼Œå¿½ç•¥å¼€å…³ï¼Œå…è®¸éƒ¨ç½²"
            exit 0
          fi

          SPA_ENABLED="${{ vars.SPA_DEPLOY }}"
          [ -z "$SPA_ENABLED" ] && SPA_ENABLED="true"

          if [ "$SPA_ENABLED" = "true" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… SPA è‡ªåŠ¨éƒ¨ç½²å·²å¼€å¯ï¼Œå…è®¸éƒ¨ç½²"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸ SPA è‡ªåŠ¨éƒ¨ç½²å·²å…³é—­ï¼Œè·³è¿‡éƒ¨ç½²"
          fi

      - name: ğŸ” æ£€æµ‹å˜æ›´èŒƒå›´
        id: changes
        run: |
          echo "ui_changed=false" >> $GITHUB_OUTPUT
          echo "worker_changed=false" >> $GITHUB_OUTPUT
          echo "migrations_changed=false" >> $GITHUB_OUTPUT

          if [[ "${{ github.event_name }}" == "push" ]]; then
            before="${{ github.event.before }}"
            if [[ -z "$before" || "$before" == "0000000000000000000000000000000000000000" ]]; then
              echo "ui_changed=true" >> $GITHUB_OUTPUT
              echo "worker_changed=true" >> $GITHUB_OUTPUT
              echo "migrations_changed=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            if ! git cat-file -e "$before^{commit}" 2>/dev/null; then
              echo "âš ï¸ before æäº¤ä¸å­˜åœ¨ï¼Œé»˜è®¤è§†ä¸ºå…¨é‡å˜æ›´"
              echo "ui_changed=true" >> $GITHUB_OUTPUT
              echo "worker_changed=true" >> $GITHUB_OUTPUT
              echo "migrations_changed=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            CHANGED=$(git diff --name-only "$before" "${{ github.sha }}")

            if echo "$CHANGED" | grep -q "^apps/ui/"; then
              echo "ui_changed=true" >> $GITHUB_OUTPUT
            fi
            if echo "$CHANGED" | grep -q "^apps/worker/"; then
              echo "worker_changed=true" >> $GITHUB_OUTPUT
            fi
            if echo "$CHANGED" | grep -q "^apps/worker/migrations/"; then
              echo "migrations_changed=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ğŸ§­ ç”Ÿæˆéƒ¨ç½²è®¡åˆ’
        id: plan
        run: |
          event="${{ github.event_name }}"
          deploy_action="${{ github.event.inputs.deploy_action }}"
          deploy_target="${{ github.event.inputs.deploy_target }}"
          apply_migrations="${{ github.event.inputs.apply_migrations }}"

          if [[ "$event" == "repository_dispatch" ]]; then
            if [[ -n "${{ github.event.client_payload.deploy_target }}" ]]; then
              deploy_target="${{ github.event.client_payload.deploy_target }}"
            fi
            if [[ -n "${{ github.event.client_payload.apply_migrations }}" ]]; then
              apply_migrations="${{ github.event.client_payload.apply_migrations }}"
            fi
            if [[ -n "${{ github.event.client_payload.deploy_action }}" ]]; then
              deploy_action="${{ github.event.client_payload.deploy_action }}"
            fi
          fi

          if [[ -z "$deploy_action" ]]; then
            deploy_action="update"
          fi
          if [[ -z "$deploy_target" ]]; then
            deploy_target="auto"
          fi
          if [[ -z "$apply_migrations" ]]; then
            apply_migrations="auto"
          fi
          if [[ "$deploy_action" == "init" ]]; then
            deploy_target="both"
            apply_migrations="true"
          fi

          ui_changed="${{ steps.changes.outputs.ui_changed }}"
          worker_changed="${{ steps.changes.outputs.worker_changed }}"
          migrations_changed="${{ steps.changes.outputs.migrations_changed }}"

          deploy_ui="false"
          deploy_worker="false"

          case "$deploy_target" in
            frontend)
              deploy_ui="true"
              deploy_worker="true"
              ;;
            backend)
              deploy_ui="false"
              deploy_worker="true"
              ;;
            both)
              deploy_ui="true"
              deploy_worker="true"
              ;;
            auto|*)
              if [[ "$event" == "push" ]]; then
                if [[ "$ui_changed" == "true" ]]; then
                  deploy_ui="true"
                fi
                if [[ "$worker_changed" == "true" ]]; then
                  deploy_worker="true"
                fi
              else
                deploy_ui="true"
                deploy_worker="true"
              fi
              ;;
          esac

          should_migrate="false"
          if [[ "$apply_migrations" == "true" ]]; then
            should_migrate="true"
          elif [[ "$apply_migrations" == "auto" ]]; then
            if [[ "$event" == "push" && "$migrations_changed" == "true" ]]; then
              should_migrate="true"
            fi
          fi

          echo "deploy_action=$deploy_action" >> $GITHUB_OUTPUT
          echo "deploy_target=$deploy_target" >> $GITHUB_OUTPUT
          echo "apply_migrations=$apply_migrations" >> $GITHUB_OUTPUT
          echo "deploy_ui=$deploy_ui" >> $GITHUB_OUTPUT
          echo "deploy_worker=$deploy_worker" >> $GITHUB_OUTPUT
          echo "should_migrate=$should_migrate" >> $GITHUB_OUTPUT

  init-spa:
    needs: check-config
    if: needs.check-config.outputs.should_deploy == 'true' && needs.check-config.outputs.deploy_action == 'init'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.3.9"

      - name: Show init plan
        run: |
          echo "deploy_action=${{ needs.check-config.outputs.deploy_action }}"
          echo "deploy_target=${{ needs.check-config.outputs.deploy_target }}"
          echo "apply_migrations=${{ needs.check-config.outputs.apply_migrations }}"
          echo "deploy_ui=${{ needs.check-config.outputs.deploy_ui }}"
          echo "deploy_worker=${{ needs.check-config.outputs.deploy_worker }}"
          echo "should_migrate=${{ needs.check-config.outputs.should_migrate }}"

      - name: Check if D1 database exists
        id: check-db
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "æ£€æŸ¥ D1 æ•°æ®åº“æ˜¯å¦å·²å­˜åœ¨..."
          DATABASE_LIST=$(bunx wrangler d1 list --json --config apps/worker/wrangler.toml 2>/dev/null || echo "[]")
          EXISTING_DB=$(echo "$DATABASE_LIST" | jq -r '.[] | select(.name=="api-worker") | .uuid')

          if [ -n "$EXISTING_DB" ]; then
            echo "db_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… D1 å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–"
          else
            echo "db_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check-db.outputs.db_exists != 'true'
        run: bun install

      - name: Build UI
        if: steps.check-db.outputs.db_exists != 'true' && (needs.check-config.outputs.deploy_ui == 'true' || needs.check-config.outputs.deploy_worker == 'true')
        run: bun run --filter api-worker-ui build

      - name: Verify UI build
        if: steps.check-db.outputs.db_exists != 'true' && (needs.check-config.outputs.deploy_ui == 'true' || needs.check-config.outputs.deploy_worker == 'true')
        run: |
          if [ ! -d "apps/ui/dist" ]; then
            echo "âŒ UI æ„å»ºå¤±è´¥ï¼šdist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f "apps/ui/dist/index.html" ]; then
            echo "âŒ UI æ„å»ºå¤±è´¥ï¼šindex.html ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… UI æ„å»ºäº§ç‰©å·²å°±ç»ª"

      - name: Disable wrangler telemetry
        if: steps.check-db.outputs.db_exists != 'true'
        run: bunx wrangler telemetry disable

      - name: Create D1 database (init only)
        if: steps.check-db.outputs.db_exists != 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "åˆ›å»º D1 æ•°æ®åº“..."
          CREATE_OUTPUT=$(bunx wrangler d1 create api-worker --config apps/worker/wrangler.toml 2>&1)

          if echo "$CREATE_OUTPUT" | grep -q "database_id"; then
            DATABASE_ID=$(echo "$CREATE_OUTPUT" | grep -oP "database_id = \"\K[^\"]+")
            if [ -z "$DATABASE_ID" ]; then
              DATABASE_ID=$(echo "$CREATE_OUTPUT" | grep -oP "([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})")
            fi
          else
            LIST_OUTPUT=$(bunx wrangler d1 list --json --config apps/worker/wrangler.toml 2>/dev/null || echo "[]")
            DATABASE_ID=$(echo "$LIST_OUTPUT" | jq -r '.[] | select(.name=="api-worker") | .uuid')
          fi

          if [ -z "$DATABASE_ID" ]; then
            echo "âŒ æ— æ³•åˆ›å»ºæˆ–æ‰¾åˆ° D1 æ•°æ®åº“"
            exit 1
          fi

          sed -i -E "s/(database_id = \")([^\"]+)(\")/\\1$DATABASE_ID\\3/" apps/worker/wrangler.toml
          echo "database_id=$DATABASE_ID" >> $GITHUB_ENV

      - name: Apply D1 migrations (remote)
        if: steps.check-db.outputs.db_exists != 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bunx wrangler d1 migrations apply DB --remote --config apps/worker/wrangler.toml

      - name: Deploy to Cloudflare Workers (SPA Mode)
        if: steps.check-db.outputs.db_exists != 'true' && (needs.check-config.outputs.deploy_worker == 'true' || needs.check-config.outputs.deploy_ui == 'true')
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bunx wrangler deploy --config apps/worker/wrangler.toml

      - name: Set Linux DO OAuth secrets
        if: steps.check-db.outputs.db_exists != 'true' && (needs.check-config.outputs.deploy_worker == 'true' || needs.check-config.outputs.deploy_ui == 'true')
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -n "${{ secrets.LINUXDO_CLIENT_ID }}" ]; then
            echo "${{ secrets.LINUXDO_CLIENT_ID }}" | bunx wrangler secret put LINUXDO_CLIENT_ID --config apps/worker/wrangler.toml
          fi
          if [ -n "${{ secrets.LINUXDO_CLIENT_SECRET }}" ]; then
            echo "${{ secrets.LINUXDO_CLIENT_SECRET }}" | bunx wrangler secret put LINUXDO_CLIENT_SECRET --config apps/worker/wrangler.toml
          fi

  deploy-spa:
    needs: check-config
    if: needs.check-config.outputs.should_deploy == 'true' && needs.check-config.outputs.deploy_action != 'init'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.3.9"

      - name: Show deploy plan
        run: |
          echo "deploy_action=${{ needs.check-config.outputs.deploy_action }}"
          echo "deploy_target=${{ needs.check-config.outputs.deploy_target }}"
          echo "apply_migrations=${{ needs.check-config.outputs.apply_migrations }}"
          echo "ui_changed=${{ needs.check-config.outputs.ui_changed }}"
          echo "worker_changed=${{ needs.check-config.outputs.worker_changed }}"
          echo "migrations_changed=${{ needs.check-config.outputs.migrations_changed }}"
          echo "deploy_ui=${{ needs.check-config.outputs.deploy_ui }}"
          echo "deploy_worker=${{ needs.check-config.outputs.deploy_worker }}"
          echo "should_migrate=${{ needs.check-config.outputs.should_migrate }}"

      - name: Check if deploy button trigger
        id: check-deploy-button
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" && "${{ github.event.action }}" == "deploy-spa-button" ]]; then
            echo "is_deploy_button=true" >> $GITHUB_OUTPUT
          else
            echo "is_deploy_button=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: bun install

      - name: Build UI
        if: needs.check-config.outputs.deploy_ui == 'true' || needs.check-config.outputs.deploy_worker == 'true'
        run: bun run --filter api-worker-ui build

      - name: Verify UI build
        if: needs.check-config.outputs.deploy_ui == 'true' || needs.check-config.outputs.deploy_worker == 'true'
        run: |
          if [ ! -d "apps/ui/dist" ]; then
            echo "âŒ UI æ„å»ºå¤±è´¥ï¼šdist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f "apps/ui/dist/index.html" ]; then
            echo "âŒ UI æ„å»ºå¤±è´¥ï¼šindex.html ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… UI æ„å»ºäº§ç‰©å·²å°±ç»ª"

      - name: Disable wrangler telemetry
        run: bunx wrangler telemetry disable

      - name: Create or verify D1 Database
        if: needs.check-config.outputs.deploy_worker == 'true' || needs.check-config.outputs.deploy_ui == 'true' || needs.check-config.outputs.should_migrate == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "æ£€æŸ¥å¹¶åˆ›å»º D1 æ•°æ®åº“..."
          DATABASE_LIST=$(bunx wrangler d1 list --json --config apps/worker/wrangler.toml 2>/dev/null || echo "[]")
          EXISTING_DB=$(echo "$DATABASE_LIST" | jq -r '.[] | select(.name=="api-worker") | .uuid')

          if [ -n "$EXISTING_DB" ]; then
            echo "âœ… æ‰¾åˆ°ç°æœ‰ D1 æ•°æ®åº“: $EXISTING_DB"
            DATABASE_ID=$EXISTING_DB
          else
            CREATE_OUTPUT=$(bunx wrangler d1 create api-worker --config apps/worker/wrangler.toml 2>&1)

            if echo "$CREATE_OUTPUT" | grep -q "database_id"; then
              DATABASE_ID=$(echo "$CREATE_OUTPUT" | grep -oP "database_id = \"\K[^\"]+")
              if [ -z "$DATABASE_ID" ]; then
                DATABASE_ID=$(echo "$CREATE_OUTPUT" | grep -oP "([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})")
              fi
            else
              LIST_OUTPUT=$(bunx wrangler d1 list --json --config apps/worker/wrangler.toml 2>/dev/null || echo "[]")
              DATABASE_ID=$(echo "$LIST_OUTPUT" | jq -r '.[] | select(.name=="api-worker") | .uuid')

              if [ -z "$DATABASE_ID" ]; then
                echo "âŒ æ— æ³•åˆ›å»ºæˆ–æ‰¾åˆ° D1 æ•°æ®åº“"
                exit 1
              fi
            fi
          fi

          sed -i -E "s/(database_id = \")([^\"]+)(\")/\\1$DATABASE_ID\\3/" apps/worker/wrangler.toml
          echo "database_id=$DATABASE_ID" >> $GITHUB_ENV

      - name: Apply D1 migrations (remote)
        if: needs.check-config.outputs.should_migrate == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bunx wrangler d1 migrations apply DB --remote --config apps/worker/wrangler.toml

      - name: Deploy to Cloudflare Workers (SPA Mode)
        if: needs.check-config.outputs.deploy_worker == 'true' || needs.check-config.outputs.deploy_ui == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bunx wrangler deploy --config apps/worker/wrangler.toml

      - name: Set Linux DO OAuth secrets
        if: needs.check-config.outputs.deploy_worker == 'true' || needs.check-config.outputs.deploy_ui == 'true'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ -n "${{ secrets.LINUXDO_CLIENT_ID }}" ]; then
            echo "${{ secrets.LINUXDO_CLIENT_ID }}" | bunx wrangler secret put LINUXDO_CLIENT_ID --config apps/worker/wrangler.toml
          fi
          if [ -n "${{ secrets.LINUXDO_CLIENT_SECRET }}" ]; then
            echo "${{ secrets.LINUXDO_CLIENT_SECRET }}" | bunx wrangler secret put LINUXDO_CLIENT_SECRET --config apps/worker/wrangler.toml
          fi

      - name: Display Success Information
        if: steps.check-deploy-button.outputs.is_deploy_button == 'true' && success()
        run: |
          echo "===================================================="
          echo "ğŸ‰ SPA Worker å·²æˆåŠŸéƒ¨ç½²åˆ° Cloudflare Workers!"
          echo "===================================================="
          echo "åç»­æ­¥éª¤ï¼š"
          echo "1. è®¿é—®æ‚¨çš„ Worker URL"
          echo "2. ç™»å½•åç«‹åˆ»ä¿®æ”¹ç®¡ç†å‘˜å¯†ç "
          echo "3. é…ç½®ç›¸å…³ç³»ç»Ÿå‚æ•°"
          echo "===================================================="

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… SPA Worker éƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ SPA Worker éƒ¨ç½²å¤±è´¥ï¼"
          fi

