name: Deploy SPA CF Workers[Workerä¸€ä½“åŒ–éƒ¨ç½²]

on:
  push:
    branches: [main, master]
    paths:
      - "apps/ui/**"
      - "apps/worker/**"
  workflow_dispatch:
    inputs:
      from_panel:
        description: "æ˜¯å¦ç”±éƒ¨ç½²æ§åˆ¶é¢æ¿è§¦å‘ / triggered from deployment control panel"
        required: false
        default: "false"
  repository_dispatch:
    types: [deploy-spa-button]

jobs:
  check-config:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” æ£€æŸ¥éƒ¨ç½²é…ç½®
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹åŠ¨è§¦å‘ï¼ˆrepository_dispatchï¼‰ï¼Œå¿½ç•¥å¼€å…³ï¼Œå…è®¸éƒ¨ç½²"
            exit 0
          fi

          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.from_panel }}" != "true" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰ï¼Œå¿½ç•¥å¼€å…³ï¼Œå…è®¸éƒ¨ç½²"
            exit 0
          fi

          SPA_ENABLED="${{ vars.SPA_DEPLOY }}"
          [ -z "$SPA_ENABLED" ] && SPA_ENABLED="true"

          if [ "$SPA_ENABLED" = "true" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… SPA è‡ªåŠ¨éƒ¨ç½²å·²å¼€å¯ï¼Œå…è®¸éƒ¨ç½²"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸ SPA è‡ªåŠ¨éƒ¨ç½²å·²å…³é—­ï¼Œè·³è¿‡éƒ¨ç½²"
          fi

  deploy-spa:
    needs: check-config
    if: needs.check-config.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.3.9"

      - name: Check if deploy button trigger
        id: check-deploy-button
        run: |
          if [[ "${{ github.event_name }}" == "repository_dispatch" && "${{ github.event.action }}" == "deploy-spa-button" ]]; then
            echo "is_deploy_button=true" >> $GITHUB_OUTPUT
          else
            echo "is_deploy_button=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: bun install

      - name: Build UI
        run: bun run --filter api-worker-ui build

      - name: Verify UI build
        run: |
          if [ ! -d "apps/ui/dist" ]; then
            echo "âŒ UI æ„å»ºå¤±è´¥ï¼šdist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f "apps/ui/dist/index.html" ]; then
            echo "âŒ UI æ„å»ºå¤±è´¥ï¼šindex.html ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… UI æ„å»ºäº§ç‰©å·²å°±ç»ª"

      - name: Disable wrangler telemetry
        run: bunx wrangler telemetry disable

      - name: Create or verify D1 Database
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "æ£€æŸ¥å¹¶åˆ›å»º D1 æ•°æ®åº“..."
          DATABASE_LIST=$(bunx wrangler d1 list --json --config apps/worker/wrangler.toml 2>/dev/null || echo "[]")
          EXISTING_DB=$(echo "$DATABASE_LIST" | jq -r '.[] | select(.name=="new_api_lite") | .uuid')

          if [ -n "$EXISTING_DB" ]; then
            echo "âœ… æ‰¾åˆ°ç°æœ‰ D1 æ•°æ®åº“: $EXISTING_DB"
            DATABASE_ID=$EXISTING_DB
          else
            CREATE_OUTPUT=$(bunx wrangler d1 create new_api_lite --config apps/worker/wrangler.toml 2>&1)

            if echo "$CREATE_OUTPUT" | grep -q "database_id"; then
              DATABASE_ID=$(echo "$CREATE_OUTPUT" | grep -oP "database_id = \"\K[^\"]+")
              if [ -z "$DATABASE_ID" ]; then
                DATABASE_ID=$(echo "$CREATE_OUTPUT" | grep -oP "([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})")
              fi
            else
              LIST_OUTPUT=$(bunx wrangler d1 list --json --config apps/worker/wrangler.toml 2>/dev/null || echo "[]")
              DATABASE_ID=$(echo "$LIST_OUTPUT" | jq -r '.[] | select(.name=="new_api_lite") | .uuid')

              if [ -z "$DATABASE_ID" ]; then
                echo "âŒ æ— æ³•åˆ›å»ºæˆ–æ‰¾åˆ° D1 æ•°æ®åº“"
                exit 1
              fi
            fi
          fi

          sed -i -E "s/(database_id = \")([^\"]+)(\")/\\1$DATABASE_ID\\3/" apps/worker/wrangler.toml
          echo "database_id=$DATABASE_ID" >> $GITHUB_ENV

      - name: Apply D1 migrations (remote)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bunx wrangler d1 migrations apply DB --remote --config apps/worker/wrangler.toml

      - name: Deploy to Cloudflare Workers (SPA Mode)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: bunx wrangler deploy --config apps/worker/wrangler.toml

      - name: Display Success Information
        if: steps.check-deploy-button.outputs.is_deploy_button == 'true' && success()
        run: |
          echo "===================================================="
          echo "ğŸ‰ SPA Worker å·²æˆåŠŸéƒ¨ç½²åˆ° Cloudflare Workers!"
          echo "===================================================="
          echo "åç»­æ­¥éª¤ï¼š"
          echo "1. è®¿é—®æ‚¨çš„ Worker URL"
          echo "2. ç™»å½•åç«‹åˆ»ä¿®æ”¹ç®¡ç†å‘˜å¯†ç "
          echo "3. é…ç½®ç›¸å…³ç³»ç»Ÿå‚æ•°"
          echo "===================================================="

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… SPA Worker éƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ SPA Worker éƒ¨ç½²å¤±è´¥ï¼"
          fi

